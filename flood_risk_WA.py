import arcpy
import os

arcpy.CheckOutExtension("Spatial")
arcpy.env.overwriteOutput = True

#Folder structure
rootdir = 'C:/Mathis/ICSL/flood_vulnerability'
datadir = os.path.join(rootdir, 'data')
resdir = os.path.join(rootdir, 'results')

gdb = os.path.join(resdir,'flood_risk.gdb')
if arcpy.Exists(gdb):
    print('Geodatabase already exists')
else:
    arcpy.CreateFileGDB_management(resdir, 'flood_risk.gdb')
arcpy.env.workspace = gdb

#Import data
FEMAdata = os.path.join(datadir, 'FEMA_20180819/NFHL_53_20180620/NFHL_53_20180620.gdb')
floodhaz =  os.path.join(FEMAdata, 'S_Fld_Haz_Ar')
USadmin = 'C:\Mathis\ICSL\stormwater\data\USA_adm_gdb\USA_adm.gdb'
USstates = os.path.join(USadmin, 'USA_adm1')
censusblock2010 = 'C:\Mathis\ICSL\stormwater\data\TIGER2017\\tabblock2010_53_pophu\\tabblock2010_53_pophu.shp'

#Projection: USA Contiguous Albers Equal Area Conic
cs = arcpy.SpatialReference(102003)

#Project FEMA
floodhazproj = 'S_Fld_Haz_Ar_proj'
arcpy.Project_management(floodhaz,floodhazproj, out_coor_system=cs)

#Dissolve flood hazard data to get footprint
arcpy.Dissolve_management(floodhazproj, 'floodhaz_diss',multi_part='SINGLE_PART')

#Create separate layer only with Special Flood Hazard Area (100-year flood zone)
#From https://www.fema.gov/flood-zones (do not include coastal flooding 'V', 'VE', ['V'+str(n) for n in range(1,31)]
#all_codes = set([r[0] for r in arcpy.da.SearchCursor(floodhazproj, ['FLD_ZONE'])])
SFHA_codes = ['A', 'AO','AH', 'AE', 'A99', 'AR', 'AR/AE', 'AR/AO', 'AR/A1-A30', 'AR/A']+['A'+str(n) for n in range(1,31)]
SQLsel = "{0} IN ('{1}')".format('"FLD_ZONE"',"', '".join(map(str, SFHA_codes)) or 'NULL')
arcpy.MakeFeatureLayer_management(floodhazproj, 'floodhaz_lyr')
arcpy.SelectLayerByAttribute_management('floodhaz_lyr', 'NEW_SELECTION',  SQLsel)
arcpy.CopyFeatures_management('floodhaz_lyr', 'floodhaz_SFHA')
#Create separate layer only with SFHA from detailed studies
arcpy.SelectLayerByAttribute_management('floodhaz_lyr', 'SUBSET_SELECTION', "NOT FLD_ZONE='A'")
arcpy.CopyFeatures_management('floodhaz_lyr', 'floodhaz_SFHA_detailed')

#Assess percentage of washington state with FEMA data
arcpy.MakeFeatureLayer_management(USstates, 'WAborder', "{}='Washington'".format('"NAME_1"'))
arcpy.CopyFeatures_management('WAborder', 'WA')
arcpy.Project_management('WA', 'WA_proj', out_coor_system=cs)
arcpy.AddGeometryAttributes_management('WA_proj', 'AREA', Area_Unit='SQUARE_KILOMETERS')
arcpy.Intersect_analysis(['WA_proj',floodhazproj], 'WAflood_inters')
sum([row[0]/((10**6)*row[1]) for row in arcpy.da.SearchCursor('WAflood_inters', ['Shape_Area','POLY_AREA'])]) #FEMA flood hazard layers only cover 34% of WA

#Assess percentage of WA population living in area with FEMA data
arcpy.Project_management(censusblock2010, 'block2010_proj', out_coor_system=cs)
arcpy.AddGeometryAttributes_management('block2010_proj', 'AREA', Area_Unit='SQUARE_KILOMETERS')
arcpy.Intersect_analysis(['block2010_proj',floodhazproj], 'blockflood_inters')
WApop = sum([row[0] for row in arcpy.da.SearchCursor(censusblock2010, ['POP10'])])
WApop_FEMA = sum([row[0]*row[1]/((10**6)*row[2]) for row in arcpy.da.SearchCursor('blockflood_inters', ['POP10','Shape_Area','POLY_AREA'])])
WApop_FEMA/WApop #49% of WA population lives in an area with a FEMA assessment


#Intall python 3.5
#Add to list of interpreters in Pycharm https://www.jetbrains.com/help/pycharm-edu/adding-existing-virtual-environment.html
#Install ethnicolr in pycharm settings

import ethnicolr
import pandas as pd
import numpy as np
import os
import re

rootdir = 'C:\Mathis\ICSL\\flood_vulnerability'
datadir = os.path.join(rootdir,'data\\')
resdir = os.path.join(rootdir,'results\\')

#----------------------------------
# Import data
#----------------------------------
#Sheet with just name, address, property ID
os.chdir(resdir)
adr = pd.read_csv(os.path.join(datadir,'snohomish\\2018 Assr Roll at 2017 Roll Close - Excel\\2018 Assr Roll at 2017 Roll Close_nameaddress.csv'),
                 low_memory=False)
adr.info()
taxpr = adr[adr['Role'] == 'TAXPR'] #Taxpayer info is often updated way before the owner's name: https://snohomishcountywa.gov/413/Owner-Taxpayer-Address-Changes
taxpr.shape

#Sheet with parcel information
ptyp = pd.read_csv(os.path.join(datadir,'snohomish\\2018 Assr Roll at 2017 Roll Close - Excel\\2018 Assr Roll at 2017 Roll Close_maindata.csv'))
pdat = taxpr.set_index('property_id').join(ptyp.set_index('PropId'), how='left')
pdat.count()

#----------------------------------
# Only keep parcels with housing
#----------------------------------
#Nursery, primary & secondary school 681
#Special training and schooling 683
#Religious activity 691
#Medical and other health services 651
#University, college 682
#Senior citizen exemption residual 110
#Correctional instituions 674
#Retirement home/orphanages 174
#Military vases and reservations 675
pdat['UseCode'].unique()
housing_codes = [111, 112, 118, 130, 122, 113, 123, 133, 135, 131, 121, 138, 134, 124, 114, 117,
                 153, 132, 150, 189,115, 188, 142, 143, 116, 119, 752, 154, 151, 152,
                 174, 175, 141, 136, 139, 137, 187, 156, 155, 144, 145] #List of UseCodes that correpsond to housing
code_query ='|'.join(str(cod) for cod in housing_codes) #Build query
pdatsub = pdat[pdat['UseCode'].notnull()]
pdat_housing = pdatsub[pdatsub['UseCode'].str.contains(code_query)]

#Format names to run ethnicolr
pdat_housing.to_csv('pdat_housing.csv')

#PARSE NAMES
# #If doesn't work, try: https://github.com/datamade/probablepeople
# For good guide on regex: https://docs.python.org/3/howto/regex.html

p=re.compile('[a-z]+')
m = p.match("aa8abb9")

#First find whether any of the companies patterns match
#Then look whether any of the other non-individuals match
#Then look whether trust matches

#Then check whether the string has & or /, if so, splits it at each of these characters
#Count number of words (including hyphenated ones):
#1: Last name
#2: Last name, First name
#3: Last name, first name, middle name
#>4: Last name, first name, middle name, suffix or additional name - flag



#Private companies
'LLC','BANK','INC','ENTERPRISES','SHARE','LTD','COMPANY','PARTNERSHIP','PARTNERS','LP','LLP',
'CO','CORP','CORPORATION','MORTGAGE','INVESTMENT','ASSOCIATES','BROKERAGE','COMPANY','CONSULTING',
'CONSULTANT','REALTY','OR','ORG','ORGANIZATION','GROUP','SERVICE','PROPERTIES','ESTATE','RANCH',
'HOLDINGS','CAPITAL','FUND','SUBSIDIARIES','LIMITED','LAW'

#Other non-individuals
'CHURCH','COUNTY','CITY','TOWN','DISTRICT','SCHOOL','COLLEGE','UNIVERSITY','INSTITUTE','FEDERAL', 'NATIONAL','ASSOC',\
'ASSOCIATION','HOUSE','VACANT', 'SNO CTY','UNION','HOSPITAL','CENTER','RETIREMENT','HOME','FARM','ASSOC',\
'POLICE','COUNCIL','OFFICE','STATE','CHAPTER','MARKET','TRIBE','SOCIETY','ALLIANCE','AUTHORITY','CLINIC','PAC',\
'GOVERNMENT','COMMITTEE','LOCAL','ACADEMY','ASSEMBLY','AGENCY'
#Trust
'TTEE','TRUSTEE', 'TRUST','GRANTEES',
#Flag



#Watch out for
#- hyphenated last names
#  'JR', 'SR','I', 'II','III', 'VAN', 'DE',

#VACANT SPACE should be classified as not housing

#Format
#Last name, first name (or initial), middle name (or initial) (& or /) (last name), first name, middle name (or initial)
#If one word before and after / or & just last name
#If only one word after & or /: first name
#If only one work + one initial after & or /: then first name, middle name
#If two full words after & or /: last name, first name


